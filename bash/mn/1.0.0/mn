#!/bin/bash
# =========================================================
# MN - Personal Dynamic Manual
# Author: 20syldev
# =========================================================

MN_DIR="$HOME/.config/mn"

# Load libraries
source "$MN_DIR/lib/core.sh"
source "$MN_DIR/lib/dat.sh"
source "$MN_DIR/lib/module.sh"
source "$MN_DIR/lib/crud.sh"
source "$MN_DIR/lib/ui.sh"

# Load modules
for _mn_module_file in "$MN_DIR"/modules/*.sh; do
    [[ -f "$_mn_module_file" ]] && source "$_mn_module_file"
done
unset _mn_module_file

# -------------------- MAIN MENU -------------------- #

show_main_menu() {
    CURRENT_MENU="main"
    USE_PAGINATION=false
    MENU_ITEMS=(
        "$T_MENU_CONNEXIONS"
        "$T_MENU_REPOS"
        "$T_MENU_ALIAS"
        "$T_MENU_FUNCS"
        "$T_MENU_DOCS"
        "$T_MENU_CONFIG"
        "$T_MENU_HELP"
    )
    MENU_ACTIONS=(
        "show_connexions_menu"
        "show_repos_menu"
        "show_alias_menu"
        "show_funcs_menu"
        "show_docs_menu"
        "show_config_menu"
        "show_help"
    )
}

# -------------------- HELP -------------------- #

show_help() {
    clear_screen
    draw_header "$T_HELP_TITLE"

    echo ""
    echo -e "  ${BOLD}$T_HELP_USAGE${NC}"
    echo "  ───────────────────────────────────────────────"
    echo -e "  mn              $T_HELP_CMD_MAIN"
    echo -e "  mn conn         $T_HELP_CMD_CONN"
    echo -e "  mn repos        $T_HELP_CMD_REPOS"
    echo -e "  mn alias        $T_HELP_CMD_ALIAS"
    echo -e "  mn funcs        $T_HELP_CMD_FUNCS"
    echo -e "  mn docs         $T_HELP_CMD_DOCS"
    echo -e "  mn help         $T_HELP_CMD_HELP"
    echo ""
    echo -e "  ${BOLD}$T_HELP_NAV${NC}"
    echo "  ───────────────────────────────────────────────"
    echo -e "  ↑/↓ $T_OR j/k    $T_HELP_NAV_ARROWS"
    echo -e "  Enter           $T_HELP_NAV_ENTER"
    echo -e "  r               $T_HELP_NAV_BACK"
    echo -e "  q               $T_HELP_NAV_QUIT"
    echo -e "  e / d / v       $T_HELP_NAV_ACTIONS"
    echo ""
    echo -e "  ${BOLD}$T_HELP_FILES${NC}"
    echo "  ───────────────────────────────────────────────"
    echo "  ~/.config/mn/data/connexions.dat  Connexions SSH"
    echo "  ~/.config/mn/data/repos.dat       Repositories"
    echo "  ~/.config/mn/data/aliases.dat     Alias"
    echo "  ~/.config/mn/data/functions.dat   Functions"
    echo ""
    echo "  ~/.bash_aliases                   Bash aliases"
    echo "  ~/.bash_functions                 Bash functions"
    echo ""

    echo -e "\n${DIM}$T_PRESS_KEY_CONTINUE${NC}"
    read -n 1 -s
    hide_cursor
    LAST_MENU=""
    show_main_menu
}

# -------------------- ENTRY POINT -------------------- #

main() {
    init_data_files

    local arg="${1:-}"

    case "$arg" in
        help|h|-h|--help)
            show_help
            return
            ;;
        "")
            main_loop
            return
            ;;
    esac

    # Look for a matching module
    for mod in $ALL_MODULES; do
        local cli_args
        cli_args=$(mod_prop "$mod" "CLI_ARGS")
        if echo "$arg" | grep -qE "^(${cli_args})$"; then
            _run_submenu "$mod"
            return
        fi
    done

    # Non-CRUD menus
    case "$arg" in
        docs|d)
            hide_cursor
            trap 'cleanup' INT TERM EXIT
            show_docs_menu
            LAST_MENU="docs"
            draw_menu "DOCUMENTATION" "true"
            while true; do
                handle_input
                local redraw="false"
                [[ -z "$LAST_MENU" ]] && redraw="true" && LAST_MENU="docs"
                local title
                title=$(get_menu_title "$CURRENT_MENU")
                draw_menu "$title" "$redraw"
            done
            ;;
        config|c)
            hide_cursor
            trap 'cleanup' INT TERM EXIT
            show_config_menu
            LAST_MENU="config"
            draw_menu "CONFIGURATION" "true"
            while true; do
                handle_input
                local redraw="false"
                [[ -z "$LAST_MENU" ]] && redraw="true" && LAST_MENU="config"
                local title
                title=$(get_menu_title "$CURRENT_MENU")
                draw_menu "$title" "$redraw"
            done
            ;;
        *)
            echo -e "${RED}$T_ERR_UNKNOWN: $arg${NC}"
            echo -e "${CYAN}mn help${NC} — $T_ERR_HELP_HINT"
            exit 1
            ;;
    esac
}

main "$@"
